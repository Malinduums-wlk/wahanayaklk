{% extends 'base.html' %}
{% load static %}

{% block title %}Admin Dashboard{% endblock %}

{% block extra_css %}
<style>
    .sections-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
        width: 100%;
    }
    .stat-card {
        background: white;
        padding: 1rem; /* reduced from 1.5rem */
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
        transition: all 0.2s;
        cursor: pointer;
        font-size: 0.95rem; /* reduced from default */
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .stat-card.active {
        border: 2px solid;
    }
    .stat-card.registered.active {
        border-color: #3f51b5;
    }
    .stat-card.pending.active {
        border-color: #4caf50;
    }
    .stat-card.admgmt.active {
        border-color: #ffc107;
    }
    .stat-card.badge.active {
        border-color: #f44336;
    }
    .status-dropdown {
        border: none;
        border-radius: 1.5rem;
        padding: 0.25rem 1.25rem;
        font-weight: 600;
        font-size: 0.95em;
        outline: none;
        cursor: pointer;
        min-width: 100px;
        text-align: center;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
    }
    .status-free {
        background: #CFF1E6;
        color: #11B981;
    }
    .status-premium {
        background: #FFF1D4;
        color: #FFBB2A;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card h3 {
        color: #666;
        font-size: 1rem; /* reduced from 1.25rem or 0.875rem */
        margin-bottom: 0.5rem;
    }

    .stat-number {
        font-size: 1.3rem; /* reduced from 2rem */
        font-weight: bold;
        color: #3f51b5;
    }

    .section-title {
        font-size: 1.1rem; /* reduced from 1.25rem */
        font-weight: 600;
        margin: 2rem 0 1rem;
        color: #333;
    }

    .data-table {
        width: 100%;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .data-table th, .data-table td {
        font-size: 0.95rem; /* reduced from default */
        padding: 0.7rem; /* reduced from 1rem */
    }

    .data-table th {
        background: #f8f9fa;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: #333;
    }

    .data-table td {
        padding: 1rem;
        border-top: 1px solid #eee;
        vertical-align: middle;
    }

    .btn-approve {
        background: #4caf50;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        border: none;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 0.875rem;
    }

    .btn-reject {
        background: #f44336;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.25rem;
        border: none;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 0.875rem;
    }

    .btn-approve:hover { background: #43a047; }
    .btn-reject:hover { background: #e53935; }

    .meta-text {
        color: #666;
        font-size: 0.875rem;
    }

    .btn, .btn-sm {
        font-size: 0.9rem; /* reduced from 0.875rem */
        padding: 0.35rem 0.7rem; /* slightly reduced */
    }

    .gap-2 {
        gap: 0.5rem;
    }

    .d-flex {
        display: flex;
        align-items: center;
    }

    .empty-state {
        text-align: center;
        padding: 2rem;
        background: #f8f9fa;
        border-radius: 0.5rem;
        margin: 1rem 0;
        font-size: 1rem; /* reduced from default */
    }

    .vehicle-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .vehicle-title {
        font-weight: 600;
        color: #333;
        font-size: 0.95rem;
    }

    .vehicle-price {
        color: #3f51b5;
        font-weight: 600;
        font-size: 0.95rem;
    }

    .vehicle-meta {
        color: #666;
        font-size: 0.875rem;
    }

    .boost-toggle-container {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .boost-toggle {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
        cursor: pointer;
    }
    
    .boost-toggle input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .boost-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #DCDDE2;
        transition: .4s;
        border-radius: 24px;
    }
    
    .boost-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: #F8F8F8;
        transition: .4s;
        border-radius: 50%;
    }
    
    .boost-checkbox:checked + .boost-slider {
        background-color: #5D7EFF;
    }
    
    .boost-checkbox:checked + .boost-slider:before {
        transform: translateX(26px);
    }

    /* Urgent Toggle Styles */
    .urgent-toggle-container {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .urgent-toggle {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
        cursor: pointer;
    }
    
    .urgent-toggle input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .urgent-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #DCDDE2;
        transition: .4s;
        border-radius: 24px;
    }
    
    .urgent-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: #F8F8F8;
        transition: .4s;
        border-radius: 50%;
    }
    
    .urgent-checkbox:checked + .urgent-slider {
        background-color: #FF6B6B;
    }
    
    .urgent-checkbox:checked + .urgent-slider:before {
        transform: translateX(26px);
    }

    .end-date-input {
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 0.875rem;
        background-color: #fff;
        transition: border-color 0.2s;
    }
    
    .end-date-input:focus {
        outline: none;
        border-color: #5D7EFF;
        box-shadow: 0 0 0 2px rgba(93, 126, 255, 0.1);
    }
    
    .end-date-input:hover {
        border-color: #5D7EFF;
    }

    /* Badge Users styles */
    .badge-table {
        width: 100%;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-bottom: 2rem;
    }

    .badge-table th {
        background: #f8f9fa;
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: #333;
    }

    .badge-table td {
        padding: 1rem;
        border-top: 1px solid #eee;
        vertical-align: middle;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        aspect-ratio: 1 / 1;
    }

    .badge-toggle {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }

    .badge-toggle input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .badge-toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
    }

    .badge-toggle-slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    .badge-toggle input:checked + .badge-toggle-slider {
        background-color: #5D7EFF;
    }

    .badge-toggle input:checked + .badge-toggle-slider:before {
        transform: translateX(26px);
    }

    .date-picker {
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 0.25rem;
        font-size: 0.875rem;
    }

    .contact-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .contact-number {
        font-weight: normal;
    }

    .whatsapp-number {
        color: #25D366;
        font-size: 0.875rem;
    }

    .pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 2rem;
    }

    .pagination a {
        padding: 0.5rem 1rem;
        border: 1px solid #ddd;
        border-radius: 0.25rem;
        color: #333;
        text-decoration: none;
    }

    .pagination a.active {
        background: #3f51b5;
        color: white;
        border-color: #3f51b5;
    }

    /* NEW: widen layout for admin dashboard only */
    .admin-dashboard-container {
        max-width: 90vw !important;
        width: 90vw !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container admin-dashboard-container py-4">
    {% csrf_token %}
    <div class="sections-grid">
        <div class="stat-card registered {% if section == 'registered' %}active{% endif %}" onclick="window.location.href='{% url 'users:admin_dashboard' %}?section=registered'">
            <h3 class="d-flex align-items-center justify-content-center">Registered Users <span class="badge bg-primary ms-2">{{ total_users }}</span></h3>
        </div>
        <div class="stat-card pending {% if section == 'pending' %}active{% endif %}" onclick="window.location.href='{% url 'users:admin_dashboard' %}?section=pending'">
            <h3>Pending Ads <span class="badge bg-success ms-2">{{ pending_ads }}</span></h3>
        </div>
        <div class="stat-card admgmt {% if section == 'admgmt' %}active{% endif %}" onclick="window.location.href='{% url 'users:admin_dashboard' %}?section=admgmt'">
            <h3>Ad Management <span class="badge bg-warning ms-2">{{ approved_ads }}</span></h3>
        </div>
        <div class="stat-card badge {% if section == 'badge' %}active{% endif %}" onclick="window.location.href='{% url 'users:admin_dashboard' %}?section=badge'">
            <h3>Badge Users <span class="badge bg-danger ms-2">550</span></h3>
        </div>
    </div>

    {% if section == 'registered' %}
        <h2 class="section-title">Registered Users <span class="badge bg-primary">{{ total_users }}</span></h2>
        <div class="mb-4">
            <form method="get" action="" style="max-width: 400px;">
                <input type="hidden" name="section" value="registered">
                <div class="input-group">
                    <input type="text" name="search" class="form-control" value="{{ search_query }}">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                    </button>
                    {% if search_query %}
                    <a href="?section=registered" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i>
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
        {% if recent_users %}
        <div class="data-table">
            <table class="w-100">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Contact</th>
                        <th>Company</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Badges</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in recent_users %}
                    <tr>
                        <td><span style="font-family:monospace;">{% if entry.profile %}{{ entry.profile.unique_id }}{% endif %}</span></td>
                        <td>
                            <div class="d-flex align-items-center">
                                {% if entry.profile and entry.profile.profile_picture %}
                                <img src="{{ entry.profile.profile_picture.url }}" alt="{{ entry.user.username }}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;margin-right:8px;">
                                {% else %}
                                <span style="display:inline-block;width:32px;height:32px;background:#eee;border-radius:50%;margin-right:8px;"></span>
                                {% endif %}
                                <div>
                                    <div>{{ entry.user.first_name }} {{ entry.user.last_name }}</div>
                                    <small class="text-muted">@{{ entry.user.username }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="contact-info">
                                {% if entry.profile.contact_phone %}
                                <div class="contact-number">{{ entry.profile.contact_phone }}</div>
                                {% endif %}
                                {% if entry.profile.whatsapp_number %}
                                <div class="whatsapp-number">
                                    <i class="fab fa-whatsapp"></i> {{ entry.profile.whatsapp_number }}
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            {% if entry.profile and entry.profile.is_premium and entry.shop and entry.shop.company_name %}
                                {{ entry.shop.company_name }}
                            {% endif %}
                        </td>
                        <td>{{ entry.user.date_joined|date:"M d, Y" }}</td>
                        <td>
                            <form method="post" action="{% url 'users:toggle_premium' entry.user.id %}" style="display:inline;">
                                {% csrf_token %}
                                <select name="status" onchange="this.form.submit()" class="status-dropdown {% if entry.profile and entry.profile.is_premium %}status-premium{% else %}status-free{% endif %}">
                                    <option value="free" {% if not entry.profile or not entry.profile.is_premium %}selected{% endif %} class="status-free">Free</option>
                                    <option value="premium" {% if entry.profile and entry.profile.is_premium %}selected{% endif %} class="status-premium">Premium</option>
                                </select>
                            </form>
                        </td>
                        <td></td>
                        <td>
                            <form method="post" action="{% url 'users:remove_user' entry.user.id %}" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="pagination">
            {% if recent_users_page.has_previous %}
                <a href="?section=registered{% if search_query %}&search={{ search_query }}{% endif %}&page={{ recent_users_page.previous_page_number }}">&laquo; Previous</a>
            {% endif %}
            {% for num in recent_users_page.paginator.page_range %}
                {% if num == recent_users_page.number %}
                    <a href="?section=registered{% if search_query %}&search={{ search_query }}{% endif %}&page={{ num }}" class="active">{{ num }}</a>
                {% else %}
                    <a href="?section=registered{% if search_query %}&search={{ search_query }}{% endif %}&page={{ num }}">{{ num }}</a>
                {% endif %}
            {% endfor %}
            {% if recent_users_page.has_next %}
                <a href="?section=registered{% if search_query %}&search={{ search_query }}{% endif %}&page={{ recent_users_page.next_page_number }}">Next &raquo;</a>
            {% endif %}
        </div>
        {% else %}
        <div class="empty-state">
            <p class="mb-0">No users registered yet</p>
        </div>
        {% endif %}
    {% elif section == 'pending' %}
        <h2 class="section-title">Pending Ads <span class="badge bg-success">{{ pending_ads }}</span></h2>
        <div class="mb-4">
            <form method="get" action="" style="max-width: 400px;">
                <input type="hidden" name="section" value="pending">
                <div class="input-group">
                    <input type="text" name="search" class="form-control" value="{{ search_query }}">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                    </button>
                    {% if search_query %}
                    <a href="?section=pending" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i>
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
        {% if pending_vehicles %}
        <div class="data-table">
            <table class="w-100">
                <thead>
                    <tr>
                        <th>Ad ID</th>
                        <th>Vehicle</th>
                        <th>Type</th>
                        <th>Posted By</th>
                        <th>Date</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vehicle in pending_vehicles_page %}
                    <tr>
                        <td><span style="font-family:monospace;">#{{ vehicle.ad_id }}</span></td>
                        <td>
                            <div class="d-flex align-items-center">
                                {% if vehicle.images.first %}
                                <img src="{{ vehicle.images.first.image.url }}" alt="{{ vehicle.make }} {{ vehicle.model }}" style="width:60px;height:45px;object-fit:cover;border-radius:4px;margin-right:12px;">
                                {% else %}
                                <div style="width:60px;height:45px;background:#eee;border-radius:4px;margin-right:12px;display:flex;align-items:center;justify-content:center;">
                                    <i class="fas fa-car text-muted"></i>
                                </div>
                                {% endif %}
                                <div>
                                    <div class="fw-medium">{{ vehicle.make }} {{ vehicle.model }} {{ vehicle.year }}</div>
                                    <div class="text-muted">Rs. {{ vehicle.price|floatformat:0 }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge" style="background:#E3F2FD;color:#1976D2;">{{ vehicle.vehicle_type|title }}</span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                {% if vehicle.user.userprofile.profile_picture %}
                                <img src="{{ vehicle.user.userprofile.profile_picture.url }}" alt="{{ vehicle.user.username }}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;margin-right:8px;">
                                {% else %}
                                <div style="width:32px;height:32px;background:#eee;border-radius:50%;margin-right:8px;"></div>
                                {% endif %}
                                <div>
                                    <div class="fw-medium">
                                        {% if vehicle.user.first_name or vehicle.user.last_name %}
                                            {{ vehicle.user.first_name }} {{ vehicle.user.last_name }}
                                        {% else %}
                                            {{ vehicle.user.username }}
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">{% if vehicle.user.userprofile %}{{ vehicle.user.userprofile.unique_id }}{% endif %}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>{{ vehicle.created_at|date:"Y-m-d" }}</div>
                        </td>
                        <td>
                            <form method="post" action="{% url 'users:manage_ad' vehicle.id %}?section=pending" class="d-flex gap-2">
                                {% csrf_token %}
                                <a href="{% url 'ads:detail' vehicle.id %}" class="btn" style="background:#E3F2FD;color:#1976D2;" target="_blank">
                                    View
                                </a>
                                <button type="submit" name="action" value="approve" class="btn" style="background:#CFF1E6;color:#11B981;">
                                    Approve
                                </button>
                                <button type="submit" name="action" value="reject" class="btn" style="background:#F9D2DA;color:#E11D48;">
                                    Reject
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="pagination">
            {% if pending_vehicles_page.has_previous %}
                <a href="?section=pending{% if search_query %}&search={{ search_query }}{% endif %}&page={{ pending_vehicles_page.previous_page_number }}">&laquo; Previous</a>
            {% endif %}
            {% for num in pending_vehicles_page.paginator.page_range %}
                {% if num == pending_vehicles_page.number %}
                    <a href="?section=pending{% if search_query %}&search={{ search_query }}{% endif %}&page={{ num }}" class="active">{{ num }}</a>
                {% else %}
                    <a href="?section=pending{% if search_query %}&search={{ search_query }}{% endif %}&page={{ num }}">{{ num }}</a>
                {% endif %}
            {% endfor %}
            {% if pending_vehicles_page.has_next %}
                <a href="?section=pending{% if search_query %}&search={{ search_query }}{% endif %}&page={{ pending_vehicles_page.next_page_number }}">Next &raquo;</a>
            {% endif %}
        </div>
        {% else %}
        <div class="empty-state">
            <p class="mb-0">No pending ads to review</p>
        </div>
        {% endif %}
    {% elif section == 'admgmt' %}
        <h2 class="section-title">Ad Management <span class="badge bg-warning">{{ approved_ads }}</span></h2>
        <div class="mb-4">
            <form method="get" action="" style="max-width: 400px;">
                <input type="hidden" name="section" value="admgmt">
                <div class="input-group">
                    <input type="text" name="search" class="form-control" value="{{ search_query }}">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                    </button>
                    {% if search_query %}
                    <a href="?section=admgmt" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i>
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
        {% if all_vehicles %}
        <div class="data-table">
            <table class="w-100">
                <thead>
                    <tr>
                        <th>Ad ID</th>
                        <th>User ID</th>
                        <th>AD</th>
                        <th>Boost</th>
                        <th>End Date</th>
                        <th>Urgent</th>
                        <th>End Date</th>
                        <th>Status</th>
                        <th>Contact</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vehicle in all_vehicles_page %}
                    <tr data-vehicle-id="{{ vehicle.id }}">
                        <td><span style="font-family:monospace;">#{{ vehicle.ad_id }}</span></td>
                        <td>
                            <span style="font-family:monospace;">{% if vehicle.user.userprofile %}{{ vehicle.user.userprofile.unique_id }}{% endif %}</span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                {% if vehicle.images.first %}
                                <img src="{{ vehicle.images.first.image.url }}" alt="{{ vehicle.make }} {{ vehicle.model }}" style="width:60px;height:45px;object-fit:cover;border-radius:4px;margin-right:12px;">
                                {% else %}
                                <div style="width:60px;height:45px;background:#eee;border-radius:4px;margin-right:12px;display:flex;align-items:center;justify-content:center;">
                                    <i class="fas fa-car text-muted"></i>
                                </div>
                                {% endif %}
                                <div>
                                    <a href="{% url 'ads:detail' vehicle.id %}" class="vehicle-title text-decoration-none">{{ vehicle.year }} {{ vehicle.make }} {{ vehicle.model }}</a>
                                    <div class="vehicle-price">Rs. {{ vehicle.price|floatformat:0 }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="boost-toggle-container">
                                <label class="boost-toggle">
                                    <input type="checkbox" class="boost-checkbox" data-vehicle-id="{{ vehicle.id }}" {% if vehicle.is_boosted %}checked{% endif %}>
                                    <span class="boost-slider"></span>
                                </label>
                            </div>
                        </td>
                        <td>
                            <input type="date" class="form-control form-control-sm end-date-input" data-vehicle-id="{{ vehicle.id }}" value="{{ vehicle.boost_end_date|date:'Y-m-d' }}" style="min-width: 120px;">
                        </td>
                        <td>
                            <div class="urgent-toggle-container">
                                <label class="urgent-toggle">
                                    <input type="checkbox" class="urgent-checkbox" data-vehicle-id="{{ vehicle.id }}" {% if vehicle.is_urgent %}checked{% endif %}>
                                    <span class="urgent-slider"></span>
                                </label>
                            </div>
                        </td>
                        <td>
                            <input type="date" class="form-control form-control-sm urgent-end-date-input" data-vehicle-id="{{ vehicle.id }}" value="{{ vehicle.urgent_end_date|date:'Y-m-d' }}" style="min-width: 120px;">
                        </td>
                        <td>
                            {% if vehicle.status == 'pending' %}
                            <span class="badge" style="background:#FFF3CD;color:#856404;">Pending</span>
                            {% elif vehicle.status == 'approved' %}
                            <span class="badge" style="background:#D4EDDA;color:#155724;">Live</span>
                            {% else %}
                            <span class="badge" style="background:#F8D7DA;color:#721C24;">Rejected</span>
                            {% endif %}
                        </td>
                        <td>
                            <div>{{ vehicle.phone_number }}</div>
                            {% if vehicle.whatsapp_number %}
                            <small class="text-muted">WhatsApp: {{ vehicle.whatsapp_number }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-link text-danger p-0 border-0 bg-transparent" onclick="deleteAd('{{ vehicle.id }}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="pagination">
            {% if all_vehicles_page.has_previous %}
                <a href="?section=admgmt{% if search_query %}&search={{ search_query }}{% endif %}&page={{ all_vehicles_page.previous_page_number }}">&laquo; Previous</a>
            {% endif %}
            {% for num in all_vehicles_page.paginator.page_range %}
                {% if num == all_vehicles_page.number %}
                    <a href="?section=admgmt{% if search_query %}&search={{ search_query }}{% endif %}&page={{ num }}" class="active">{{ num }}</a>
                {% else %}
                    <a href="?section=admgmt{% if search_query %}&search={{ search_query }}{% endif %}&page={{ num }}">{{ num }}</a>
                {% endif %}
            {% endfor %}
            {% if all_vehicles_page.has_next %}
                <a href="?section=admgmt{% if search_query %}&search={{ search_query }}{% endif %}&page={{ all_vehicles_page.next_page_number }}">Next &raquo;</a>
            {% endif %}
        </div>

        <script>
            // Search functionality
            const adSearchInput = document.getElementById('adSearch');
            if (adSearchInput) {
                adSearchInput.addEventListener('input', function(e) {
                const searchText = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('tbody tr');
                
                rows.forEach(row => {
                        const titleEl = row.querySelector('.vehicle-title');
                        if (!titleEl) return; // safety check
                        const adText = titleEl.textContent.toLowerCase();
                    row.style.display = adText.includes(searchText) ? '' : 'none';
                });
            });
            }

            // Delete ad function
            function deleteAd(id) {
                if (confirm('Are you sure you want to delete this ad? This action cannot be undone.')) {
                    var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    
                    console.log('Deleting ad:', id);
                    
                    // Find the delete button and disable it
                    const deleteBtn = event.target.closest('button');
                    if (deleteBtn) {
                        deleteBtn.disabled = true;
                        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                    }
                    
                    // Make the AJAX request
                    fetch('/users/admin/delete-ad/' + id + '/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(function(response) { 
                        console.log('Response status:', response.status);
                        if (!response.ok) {
                            throw new Error('Network response was not ok: ' + response.status);
                        }
                        return response.json(); 
                    })
                    .then(function(data) {
                        console.log('Response data:', data);
                        
                        if (data.status === 'success') {
                            console.log('Ad deleted successfully');
                            
                            // Show success message
                            alert(data.message);
                            
                            // Remove the row from the table
                            const row = document.querySelector(`tr[data-vehicle-id="${id}"]`);
                            if (row) {
                                row.style.backgroundColor = '#ffebee';
                                row.style.transition = 'opacity 0.5s';
                                setTimeout(function() {
                                    row.style.opacity = '0';
                                    setTimeout(function() {
                                        row.remove();
                                    }, 500);
                                }, 1000);
                            } else {
                                // If row not found, reload the page
                                window.location.reload();
                            }
                        } else {
                            console.error('Failed to delete ad:', data);
                            alert('Failed to delete ad: ' + (data.message || 'Unknown error'));
                            
                            // Re-enable the button if delete failed
                            if (deleteBtn) {
                                deleteBtn.disabled = false;
                                deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
                            }
                        }
                    })
                    .catch(function(error) {
                        console.error('Error:', error);
                        alert('Failed to delete ad: ' + error.message);
                        
                        // Re-enable the button if there was an error
                        if (deleteBtn) {
                            deleteBtn.disabled = false;
                            deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
                        }
                    });
                }
            }

            // Handle urgent toggle with backend functionality
            document.addEventListener('DOMContentLoaded', function() {
                document.querySelectorAll('.urgent-checkbox').forEach(function(checkbox) {
                    checkbox.addEventListener('change', function() {
                        var vehicleId = this.dataset.vehicleId;
                        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                        
                        console.log('Toggling urgent for vehicle:', vehicleId, 'to:', this.checked);
                        
                        // Disable the checkbox during the request
                        this.disabled = true;
                        
                        // Add visual feedback
                        var slider = this.nextElementSibling;
                        if (slider) {
                            slider.style.opacity = '0.5';
                        }
                        
                        // Make the AJAX request
                        fetch('/users/admin/toggle-urgent/' + vehicleId + '/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                is_urgent: this.checked
                            })
                        })
                        .then(function(response) { 
                            console.log('Response status:', response.status);
                            if (!response.ok) {
                                throw new Error('Network response was not ok: ' + response.status);
                            }
                            return response.json(); 
                        })
                        .then(function(data) {
                            console.log('Response data:', data);
                            
                            // Re-enable the checkbox
                            this.disabled = false;
                            if (slider) {
                                slider.style.opacity = '1';
                            }
                            
                            if (data.status === 'success') {
                                console.log('Urgent status updated successfully');
                                
                                // Show success indicator
                                if (slider) {
                                    slider.style.backgroundColor = this.checked ? '#FF6B6B' : '#DCDDE2';
                                    // Flash green briefly
                                    slider.style.backgroundColor = '#28a745';
                                    setTimeout(function() {
                                        slider.style.backgroundColor = this.checked ? '#FF6B6B' : '#DCDDE2';
                                    }.bind(this), 1000);
                                }
                                
                                // Reload the page to reflect the change
                                setTimeout(function() {
                                    window.location.reload();
                                }, 1000);
                            } else {
                                // Revert the checkbox if the update failed
                                this.checked = !this.checked;
                                console.error('Failed to update urgent status:', data);
                                alert('Failed to update urgent status');
                            }
                        }.bind(this))
                        .catch(function(error) {
                            console.error('Error:', error);
                            // Revert the checkbox if there was an error
                            this.checked = !this.checked;
                            this.disabled = false;
                            if (slider) {
                                slider.style.opacity = '1';
                            }
                            alert('Failed to update urgent status: ' + error.message);
                        }.bind(this));
                    });
                });

                // Handle boost toggle with backend functionality
                document.querySelectorAll('.boost-checkbox').forEach(function(checkbox) {
                    checkbox.addEventListener('change', function() {
                        var vehicleId = this.dataset.vehicleId;
                        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                        
                        console.log('Toggling boost for vehicle:', vehicleId, 'to:', this.checked);
                        
                        // Disable the checkbox during the request
                        this.disabled = true;
                        
                        // Add visual feedback
                        var slider = this.nextElementSibling;
                        if (slider) {
                            slider.style.opacity = '0.5';
                        }
                        
                        // Make the AJAX request
                        fetch('/users/admin/toggle-boost/' + vehicleId + '/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                is_boosted: this.checked
                            })
                        })
                        .then(function(response) { 
                            console.log('Response status:', response.status);
                            if (!response.ok) {
                                throw new Error('Network response was not ok: ' + response.status);
                            }
                            return response.json(); 
                        })
                        .then(function(data) {
                            console.log('Response data:', data);
                            
                            // Re-enable the checkbox
                            this.disabled = false;
                            if (slider) {
                                slider.style.opacity = '1';
                            }
                            
                            if (data.status === 'success') {
                                console.log('Boost status updated successfully');
                                
                                // Show success indicator
                                if (slider) {
                                    slider.style.backgroundColor = this.checked ? '#FFBB2A' : '#DCDDE2';
                                    // Flash green briefly
                                    slider.style.backgroundColor = '#28a745';
                                    setTimeout(function() {
                                        slider.style.backgroundColor = this.checked ? '#FFBB2A' : '#DCDDE2';
                                    }.bind(this), 1000);
                                }
                                
                                // Reload the page to reflect the change
                                setTimeout(function() {
                                    window.location.reload();
                                }, 1000);
                            } else {
                                // Revert the checkbox if the update failed
                                this.checked = !this.checked;
                                console.error('Failed to update boost status:', data);
                                alert('Failed to update boost status');
                            }
                        }.bind(this))
                        .catch(function(error) {
                            console.error('Error:', error);
                            // Revert the checkbox if there was an error
                            this.checked = !this.checked;
                            this.disabled = false;
                            if (slider) {
                                slider.style.opacity = '1';
                            }
                            alert('Failed to update boost status: ' + error.message);
                        }.bind(this));
                    });
                });

                // Handle boost end date changes
                document.querySelectorAll('.end-date-input').forEach(function(input) {
                    input.addEventListener('change', function() {
                        var vehicleId = this.dataset.vehicleId;
                        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                        var endDate = this.value;
                        
                        console.log('Updating boost end date for vehicle:', vehicleId, 'to:', endDate);
                        
                        // Disable the input during the request
                        this.disabled = true;
                        
                        // Make the AJAX request
                        fetch('/users/admin/update-boost-end-date/' + vehicleId + '/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                end_date: endDate
                            })
                        })
                        .then(function(response) { 
                            console.log('Response status:', response.status);
                            if (!response.ok) {
                                throw new Error('Network response was not ok: ' + response.status);
                            }
                            return response.json(); 
                        })
                        .then(function(data) {
                            console.log('Response data:', data);
                            
                            // Re-enable the input
                            this.disabled = false;
                            
                            if (data.status === 'success') {
                                console.log('Boost end date updated successfully');
                                
                                // Show success indicator (flash green border briefly)
                                this.style.borderColor = '#28a745';
                                setTimeout(function() {
                                    this.style.borderColor = '';
                                }.bind(this), 1000);
                                
                                // Reload the page to reflect the change
                                setTimeout(function() {
                                    window.location.reload();
                                }, 1000);
                            } else {
                                console.error('Failed to update boost end date:', data);
                                alert('Failed to update boost end date');
                            }
                        }.bind(this))
                        .catch(function(error) {
                            console.error('Error:', error);
                            this.disabled = false;
                            alert('Failed to update boost end date: ' + error.message);
                        }.bind(this));
                    });
                });

                // Handle urgent end date changes
                document.querySelectorAll('.urgent-end-date-input').forEach(function(input) {
                    input.addEventListener('change', function() {
                        var vehicleId = this.dataset.vehicleId;
                        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                        var endDate = this.value;
                        
                        console.log('Updating urgent end date for vehicle:', vehicleId, 'to:', endDate);
                        
                        // Disable the input during the request
                        this.disabled = true;
                        
                        // Make the AJAX request
                        fetch('/users/admin/update-urgent-end-date/' + vehicleId + '/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                end_date: endDate
                            })
                        })
                        .then(function(response) { 
                            console.log('Response status:', response.status);
                            if (!response.ok) {
                                throw new Error('Network response was not ok: ' + response.status);
                            }
                            return response.json(); 
                        })
                        .then(function(data) {
                            console.log('Response data:', data);
                            
                            // Re-enable the input
                            this.disabled = false;
                            
                            if (data.status === 'success') {
                                console.log('Urgent end date updated successfully');
                                
                                // Show success indicator (flash green border briefly)
                                this.style.borderColor = '#28a745';
                                setTimeout(function() {
                                    this.style.borderColor = '';
                                }.bind(this), 1000);
                                
                                // Reload the page to reflect the change
                                setTimeout(function() {
                                    window.location.reload();
                                }, 1000);
                            } else {
                                console.error('Failed to update urgent end date:', data);
                                alert('Failed to update urgent end date');
                            }
                        }.bind(this))
                        .catch(function(error) {
                            console.error('Error:', error);
                            this.disabled = false;
                            alert('Failed to update urgent end date: ' + error.message);
                        }.bind(this));
                    });
                });
            });

        </script>
        {% else %}
        <div class="empty-state">
            <p class="mb-0">No ads found</p>
        </div>
        {% endif %}
    {% elif section == 'badge' %}
        <h2 class="section-title">Badge Users <span class="badge bg-danger">{{ profiles.paginator.count }}</span></h2>
        <div class="mb-4">
            <form method="get" action="" style="max-width: 400px;">
                <input type="hidden" name="section" value="badge">
                <div class="input-group">
                    <input type="text" name="search" class="form-control" value="{{ search_query }}" placeholder="Search users...">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                    </button>
                    {% if search_query %}
                    <a href="?section=badge" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i>
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>

        {% if profiles %}
        <div class="data-table">
            <table id="badgeTable" class="w-100">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Verified Badge</th>
                        <th>End Date</th>
                        <th>Premium Badge</th>
                        <th>End Date</th>
                        <th>Trusted Badge</th>
                        <th>Contact</th>
                    </tr>
                </thead>
                <tbody>
                    {% for profile in profiles %}
                    <tr data-user-id="{{ profile.user.id }}">
                        <td>{{ profile.unique_id }}</td>
                        <td>
                            <div class="user-info">
                                {% if profile.profile_picture %}
                                    <img src="{{ profile.profile_picture.url }}" alt="{{ profile.user.username }}" class="user-avatar">
                                {% else %}
                                    <img src="{% static 'branding/logo-main.png' %}" alt="Avatar" class="user-avatar">
                                {% endif %}
                                <div>
                                    <div class="fw-medium">{{ profile.user.get_full_name|default:profile.user.username }}</div>
                                    <small class="text-muted">{{ profile.user.email }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="boost-toggle-container">
                                <label class="boost-toggle">
                                    <input type="checkbox" class="boost-checkbox" {% if profile.has_verified_badge %}checked{% endif %}>
                                    <span class="boost-slider"></span>
                                </label>
                            </div>
                        </td>
                        <td>
                            <input type="date" class="form-control form-control-sm end-date-input" value="{{ profile.verified_badge_end_date|date:'Y-m-d' }}">
                        </td>
                        <td>
                            <div class="boost-toggle-container">
                                <label class="boost-toggle">
                                    <input type="checkbox" class="boost-checkbox" {% if profile.has_premium_badge %}checked{% endif %}>
                                    <span class="boost-slider"></span>
                                </label>
                            </div>
                        </td>
                        <td>
                            <input type="date" class="form-control form-control-sm end-date-input" value="{{ profile.premium_badge_end_date|date:'Y-m-d' }}">
                        </td>
                        <td>
                            <div class="boost-toggle-container">
                                <label class="boost-toggle">
                                    <input type="checkbox" class="boost-checkbox" {% if profile.has_trusted_badge %}checked{% endif %}>
                                    <span class="boost-slider"></span>
                                </label>
                            </div>
                        </td>
                        <td>
                            <div class="contact-info">
                                <div class="contact-number">{{ profile.contact_phone }}</div>
                                {% if profile.whatsapp_number %}
                                <div class="whatsapp-number"><i class="fab fa-whatsapp"></i> {{ profile.whatsapp_number }}</div>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="pagination">
            {% if profiles.has_previous %}
                <a href="?section=badge&page={{ profiles.previous_page_number }}">&laquo; Previous</a>
            {% endif %}
            {% for num in profiles.paginator.page_range %}
                {% if num == profiles.number %}
                    <a href="?section=badge&page={{ num }}" class="active">{{ num }}</a>
                {% else %}
                    <a href="?section=badge&page={{ num }}">{{ num }}</a>
                {% endif %}
            {% endfor %}
            {% if profiles.has_next %}
                <a href="?section=badge&page={{ profiles.next_page_number }}">Next &raquo;</a>
            {% endif %}
        </div>

        {% else %}
        <div class="empty-state">
            <p class="mb-0">No users found</p>
        </div>
        {% endif %}

        <script>
            // Simple search filter inside badge table
            const badgeSearch = document.getElementById('badgeUserSearch');
            if (badgeSearch) {
                badgeSearch.addEventListener('input', function() {
                    const term = this.value.toLowerCase();
                    document.querySelectorAll('.data-table tbody tr').forEach(row => {
                        row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
                    });
                });
            }
        </script>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const userSearch = document.getElementById('userSearch');
        const clearSearch = document.getElementById('clearSearch');
        
        if (userSearch) {
            let timeoutId;
            
            userSearch.addEventListener('input', function() {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    const searchQuery = this.value.trim();
                    const currentUrl = new URL(window.location.href);
                    currentUrl.searchParams.set('section', 'registered');
                    
                    if (searchQuery) {
                        currentUrl.searchParams.set('search', searchQuery);
                    } else {
                        currentUrl.searchParams.delete('search');
                    }
                    
                    window.location.href = currentUrl.toString();
                }, 500);
            });
            
            // Focus the search input if there's a search query
            if (userSearch.value) {
                userSearch.focus();
                userSearch.setSelectionRange(userSearch.value.length, userSearch.value.length);
            }
        }
        
        // Clear search functionality
        if (clearSearch) {
            clearSearch.addEventListener('click', function() {
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.delete('search');
                window.location.href = currentUrl.toString();
            });
        }
    });
</script>
{% endblock %} 